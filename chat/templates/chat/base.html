<!DOCTYPE HTML>

	<head>
	{% block htmlhead %}
	
		<title>Freespeech</title>

        <meta charset="iso-8859-1">		

		{% load staticfiles %}
        
        <link rel="stylesheet" href="{% static 'chat/css/bootstrap.min.css' %}" />
        <link rel="stylesheet" href="{% static 'chat/css/bootstrap-switch.min.css' %}" />
        <link rel="stylesheet" href="{% static 'chat/generated/css/style.css' %}" />
        <script src="{% static 'chat/js/ajax.js' %}"></script>
        <script src="{% static 'chat/js/jquery.min.js' %}"></script>
		<script src="{% static 'chat/js/bootstrap.min.js' %}"></script>
        <script src="{% static 'chat/js/bootstrap-switch.min.js' %}"></script>
        <script src="{% static 'chat/js/alerts.js' %}"></script>
	    <script src="{% static 'chat/js/aes.js' %}"></script>
	    <script src="{% static 'chat/js/jscrypt.js' %}"></script>
	    <script src="{% static 'chat/js/aesprng.js' %}"></script>
	    <script src="{% static 'chat/js/entropy.js' %}"></script>
	    <script src="{% static 'chat/js/md5.js' %}"></script>
        <script src="{% static 'chat/js/sha3.js' %}"></script>
	    <script src="{% static 'chat/js/linkify.js' %}"></script>
	    <script src="{% static 'chat/js/smilify.js' %}"></script>
	    <script src="{% static 'chat/js/jquery.slimscroll.min.js' %}"></script>

	{% endblock %}
	</head>

	<body>
        <div id="alertBox">
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == "error" %}
                    <div class="alert alert-danger alert-dismissable">
                          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                            <strong>Error!</strong> {{ message }}
                    </div>
                {% elif message.tags == "warning" %}
                    <div class="alert alert-warning alert-dismissable">
                          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                            <strong>Warning!</strong> {{ message }}
                    </div>
                {% elif message.tags == "info" %}
                    <div class="alert alert-info alert-dismissable">
                          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                            <strong>Info!</strong> {{ message }}
                    </div>
                {% else %}
                    <div class="alert alert-success alert-dismissable">
                          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                            <strong>Success!</strong> {{ message }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        </div>

        <section id="content">
            {% block content %}
            {% endblock %}
        </section>

        <header>
            {% block header %}

            {% if not user.is_authenticated %}
                <nav>
                    <span><a id="login-button">Log in</a> | <a id="register-button">Register</a></span>
                    <h1><a href="{% url "home" %}">FreeSpeech</a></h1>
                </nav>
            {% else %}
                <nav>
                    <span><span id="user-name">{{ user|truncatechars:20 }}</span> | <a href="{% url "logout" %}">Log out</a></span>
                    <h1><a href="{% url "home" %}">FreeSpeech</a></h1>
                </nav>
            {% endif %}

            <blockquote>
                <p>« Whereof one cannot speak, thereof one must be silent. »<p>
                <small>L.Wittgenstein in <cite title="Source Title">Tractatus</cite></small>
            </blockquote>


            <div id="cmptr-info"><h2 class="title">{{ title }}</h2> <span class="desc">{{ description }}</span></div>

            {% block header_option %}
            {% endblock %}

            {% endblock %}
	    </header>

        <aside>

            {% if not user.is_authenticated %}
                <form id="login-form" class="hidden" action="{% url "login" %}" method="post">
                    {% csrf_token %}
                    <p><input name="username" type="login" class="form-control" placeholder="Username"></p>
                    <p><input name="password" type="password" class="form-control" placeholder="Password"></p>
                    <p><input type="submit" class="btn btn-default" value="> Log in"></p>
                </form>

                <form class="formContainer hidden" method="post" action="{% url "register" %}" id="register-form">
                    {% csrf_token %}
                    {% for field in registerForm %}
                        <div class="fieldContainer">
                                {{ field }}
                        </div>
                    {% endfor %}
                        <div class="fieldContainer">
                            <input class="form-control" id="beta_key" name="beta_key" placeholder="Beta key" type="text" />
                        </div>
                    <div id="submitButton">
                        <input class="btn btn-default" type="submit" value="> Register">
                    </div>
                </form>

            {% else %}
                <div class="" id="my-comptoirs">
                    <table class="theader table table-hover">
                        <thead>
                            <td class="td-name">Comptoirs I have joined</td>
                            <td class="td-addr">Address</td>
                            <td class="td-users">Someone's here ?</td>
                        </thead>
                    </table>
                    <div class="scrollable">
                    <table class="table table-hover">
                        <tbody>
                        {% for c,n in user.comptoirs reversed %}
                        <tr id="my-{{ c.id }}">
                            <td class="td-name">
                                <span class="txt">{{ c.title }}</span>
                                {% if n != 0 %}
                                    <span class="badge active">{{ n }}</span>
                                {% endif %}
                            </td>
                            <td class="td-addr">
                            <a class="cmptr-link" value="{{ c.id }}"
                                {# url "join_comptoir" c.id #}
                                {% if c.last_message.owner != None %}
                                    class="fsp-tooltip" data-toggle="tooltip" data-original-title="Last message by {{ c.last_message.owner }}<br />({{ c.last_message.date }})" data-html="true" data-placement="left"
                                {% endif %}
                                >{{ c.id }}</a>
                            </td>
                            <td class="td-users">(Not implemented yet)</td>
                        </tr>
                        <!--</p> Hack to remove whitespace between p elements (note HTML5 compliancy)-->
                        {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            {% endif %}
            {% block footer_option %}

            <div id="aside-panel">
    <table id="options-container" class="hidden">
        <tr id="cpy-url-btn-tr">
            <td class="lbl">
                {# if not public #}
                    <button class="btn btn-default" id="copy-key-button">Copy comptoir key</button>
                {# endif #}
            </td>
            <td class="fld">
                <button class="btn btn-default" id="copy-url-button">Copy comptoir address</button>
            </td>
        </tr>

        <tr id="msg-alert-tr">
            <td class="lbl">
                <label>Sound alert ?</label>
            </td>
            <td class="fld">
                <input id="sound-alert-btn" value=1 name="sound-alert" type="checkbox" unchecked data-off-text="O" data-on-text="I" checked bootstrap-switch-disabled>
            </td>
        </tr>
        <tr id="key-tr">
            <td class="lbl">
                <label class="control-label" for="comptoir-key">Key</label>
            </td>
            <td class="fld">
                <input id="comptoir-key" class="control-label form-control" value="">
            </td>
        </tr>
        <tr id="hash-tr" class="hidden">
            <td class="lbl">
                <label class="control-label" for="comptoir-key-hash">Hash</label>
            </td>
            <td class="fld">
                <input id="comptoir-key-hash" class="form-control" value="" disabled="true">
            </td>
        </tr>
    </table>

    <form action="{% url "send" %}" method="post" id="send-form" class="hidden">
    <div id="users-connected-content">
            Online: <span id="users-connected"></span>
        </div>
        {% csrf_token %}


        <input type="hidden" id="cid" name="cid" value="{{ id }}">

    {% if user.is_authenticated %}

        <input type="hidden" id="session_key" value="{{ request.session.session_key }}">

        <textarea placeholder="What's on your mind ?" name="msg" id="new-msg" class="form-control" autofocus></textarea>

        <div class="validation">
            <input type="submit" value="Say!" class="btn btn-default submit-button">
        </div>
    {% endif %}

</form>
            </div>
            {% endblock %}
            <footer>
                {% block footer %}
		        {% endblock %}
                <div id="left-menu">
                    <a href="{% url "about" %}">About</a>
                    •
                    <a href="{% url "report" %}">Report a bug</a>
                    •
                    Version beta {{ version }}
                </div>
            </footer>
        </aside>

	    <script src="{% static 'chat/js/key_management.js' %}"></script>
	    <script src="{% static 'chat/js/form_check.js' %}"></script>
        <script type="text/javascript">
            $('.fsp-tooltip').tooltip();
            $("#login-button").click(function() {
                $("#login-form").toggleClass("hidden");
                $("#register-form").addClass("hidden");
            });
            $("#register-button").click(function() {
                $("#register-form").toggleClass("hidden");
                $("#login-form").addClass("hidden");
            });
            $("#user-name").click(function() {
                $("#my-comptoirs").toggleClass("hidden");
            });

            $('#my-comptoirs .list').slimScroll({
                width: 'auto',
                height: '160px',
                position: 'right',
                size: '4px',
                color: '#428bca',
                railColor: '#222',
                railOpacity: 0.1,
                wheelStep: 8,
                railVisible: true
            });
        </script>
        {% block additionnal_script %}
    {% if user.is_authenticated %}
        {% load socketio_tags %}
        {% socketio %}
	    <script src="{% static 'chat/js/chat.js' %}"></script>
	    <script src="{% static 'chat/js/scroll.js' %}"></script>
        <script src="{% static 'chat/js/ajax-cmptr.js' %}"></script>
    {% endif %}

    <audio id="msgAlert">
        <source src="{% static 'chat/sounds/msg.ogg' %}" type="audio/ogg">
    </audio>

	<script src="{% static 'chat/js/ZeroClipboard.min.js' %}"></script>

    <script>
        $("[name='sound-alert']").bootstrapSwitch();
        $("#sound-alert-btn").on('switchChange', function() {
            $("#sound-alert-btn").val(1 - $("#sound-alert-btn").val());
        });
//        $("#chatbox").scrollTop($("#chatbox")[0].scrollHeight);

        var urlcpy = new ZeroClipboard( document.getElementById("copy-url-button"), {
            moviePath: "{% static 'chat/flash/ZeroClipboard.swf' %}"
        } );

        urlcpy.on( 'dataRequested', function (client, args) {
            client.setText(window.location.href);
        });

        urlcpy.on( "load", function(client) {
            client.on( "complete", function(client, args) {
                pop_alert("info", "Comptoir address copied to clipboard. Share it!");
            } );
        } );

        var keycpy = new ZeroClipboard( document.getElementById("copy-key-button"), {
            moviePath: "{% static 'chat/flash/ZeroClipboard.swf' %}"
        } );

        keycpy.on( 'dataRequested', function (client, args) {
            client.setText($("#comptoir-key").val());
        });

        keycpy.on( "load", function(client) {
            client.on( "complete", function(client, args) {
                pop_alert("info", "Comptoir key copied to clipboard. Share it!");
            } );
        } );


        $('#chatbox').slimScroll({
            height: 'auto',
            position: 'right',
            size: '2px',
            railSize: '1px',
            distance: '20px',
            color: '#428bca',
            railColor: '#222',
            railOpacity: 0.1,
            wheelStep: 8,
            railVisible: true,
        });

        if (window.location.pathname != "/") {
            $("#options-container").removeClass("hidden");
            $("#send-form").removeClass("hidden");
        }
    </script>

        {% endblock %}

	</body>

</html>
